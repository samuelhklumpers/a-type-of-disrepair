<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="annot"><span class="hs-comment">{-|
This module defines a class of non-deterministic dynamic programming problems and the means to solve/optimize them.
The framework targets a slightly different set of problems, but some parts take after: https://hackage.haskell.org/package/HyloDP-1.0.0/docs/HyloDP-Base.html, but targets

This module does:
- provide modeling for non-deterministic dynamic programming
    - this allows the &quot;reward&quot; of an action to depend on multiple successor states
- abstract over the search procedure used to determine the optimal action, allowing for:
    - exhaustive searches over finite domains
    - a golden section search for unimodal objectives over &quot;infinite&quot; domains
    - something smarter if you want?
- solve the problem while returning the entire table of subsolutions
    - (the solver needs the entire table anyway).

It does not:
- use algebraic infrastructure to explain dynamic programming is actually described by a hylomorphism (not sure if this one actually still is)
- use MemoTrie (it explodes for some reason, but generally speaking the hashmap isn't the bottleneck anyway)
- use Semirings to describe formulate optimality and the reported statistics at the type level
-}</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DP</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier">DPProblem</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="DP.html#enumSearch"><span class="hs-identifier">enumSearch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="DP.html#uniSearch"><span class="hs-identifier">uniSearch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="DP.html#execDP"><span class="hs-identifier">execDP</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="DP.html#reducedP"><span class="hs-identifier">reducedP</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="DP.html#reducedDP"><span class="hs-identifier">reducedDP</span></a></span><span>
</span><span id="line-34"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">maximumBy</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">on</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Hashable</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modifyIORef'</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="annot"><span class="hs-comment">{-|
The type of dynamic programming problems valued in `v`, with states `s` and actions `a`.

The (usually) Monad `m` can be used to compute something if you need, usually it's one of:
- Identity
- IO/ST
- a transformer stack including memoization

(The decomposition into subproblems is encoded in `actValue`).
-}</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">data</span><span> </span><span id="DPProblem"><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-var">DPProblem</span></a></span></span><span> </span><span id="local-6989586621679066315"><span class="annot"><a href="#local-6989586621679066315"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679066316"><span class="annot"><a href="#local-6989586621679066316"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621679066317"><span class="annot"><a href="#local-6989586621679066317"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679066318"><span class="annot"><a href="#local-6989586621679066318"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-53"></span><span>    </span><span id="DPProblem"><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-var">DPProblem</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-54"></span><span>        </span><span class="annot"><span class="hs-comment">-- | The search procedure over `a`.</span></span><span>
</span><span id="line-55"></span><span>        </span><span id="search"><span class="annot"><span class="annottext">forall s v a (m :: * -&gt; *). DPProblem s v a m -&gt; Search s v a m
</span><a href="DP.html#search"><span class="hs-identifier hs-var hs-var">search</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="DP.html#Search"><span class="hs-identifier hs-type">Search</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066315"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066316"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066317"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066318"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>        </span><span class="annot"><span class="hs-comment">-- | Returns the objective value of performing an action `a` in a state `s`.</span></span><span>
</span><span id="line-57"></span><span>        </span><span id="actValue"><span class="annot"><span class="annottext">forall s v a (m :: * -&gt; *).
DPProblem s v a m -&gt; s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
</span><a href="DP.html#actValue"><span class="hs-identifier hs-var hs-var">actValue</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679066315"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066315"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066316"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066317"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066316"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">type</span><span> </span><span id="Search"><span class="annot"><a href="DP.html#Search"><span class="hs-identifier hs-var">Search</span></a></span></span><span> </span><span id="local-6989586621679066445"><span class="annot"><a href="#local-6989586621679066445"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679066446"><span class="annot"><a href="#local-6989586621679066446"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621679066447"><span class="annot"><a href="#local-6989586621679066447"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679066448"><span class="annot"><a href="#local-6989586621679066448"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679066445"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066447"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066446"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066446"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066447"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><span class="hs-comment">{-|
Given a function `s -&gt; Either v [a]` indicating whether a state is either:
- terminal with value `v`
- allows for actions `[a]` to be taken
this procedure exhaustively searches the list for the action with the optimal objective.
-}</span></span><span>
</span><span id="line-68"></span><span id="local-6989586621679066329"><span id="local-6989586621679066330"><span id="local-6989586621679066331"><span id="local-6989586621679066332"><span class="annot"><a href="DP.html#enumSearch"><span class="hs-identifier hs-type">enumSearch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679066329"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679066330"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066331"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679066329"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679066332"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="DP.html#Search"><span class="hs-identifier hs-type">Search</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066331"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066329"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066332"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066330"><span class="hs-identifier hs-type">m</span></a></span></span></span></span></span><span>
</span><span id="line-69"></span><span id="enumSearch"><span class="annot"><span class="annottext">enumSearch :: forall v (m :: * -&gt; *) s a.
(Ord v, Monad m) =&gt;
(s -&gt; Either v [a]) -&gt; Search s v a m
</span><a href="DP.html#enumSearch"><span class="hs-identifier hs-var hs-var">enumSearch</span></a></span></span><span> </span><span id="local-6989586621679066464"><span class="annot"><span class="annottext">s -&gt; Either v [a]
</span><a href="#local-6989586621679066464"><span class="hs-identifier hs-var">actOrEnd</span></a></span></span><span> </span><span id="local-6989586621679066465"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066465"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679066466"><span class="annot"><span class="annottext">a -&gt; m v
</span><a href="#local-6989586621679066466"><span class="hs-identifier hs-var">actValue'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">s -&gt; Either v [a]
</span><a href="#local-6989586621679066464"><span class="hs-identifier hs-var">actOrEnd</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066465"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679066467"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066467"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; m (v, Maybe a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066467"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679066468"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679066468"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>        </span><span id="local-6989586621679066469"><span class="annot"><span class="annottext">[(v, a)]
</span><a href="#local-6989586621679066469"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m (v, a)) -&gt; [a] -&gt; m [(v, a)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621679066471"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679066471"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679066471"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(v -&gt; (v, a)) -&gt; m v -&gt; m (v, a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m v
</span><a href="#local-6989586621679066466"><span class="hs-identifier hs-var">actValue'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679066471"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679066468"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-73"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621679066477"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066477"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679066478"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679066478"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((v, a) -&gt; (v, a) -&gt; Ordering) -&gt; [(v, a)] -&gt; (v, a)
forall (t :: * -&gt; *) a.
Foldable t =&gt;
(a -&gt; a -&gt; Ordering) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximumBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; v -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(v -&gt; v -&gt; Ordering)
-&gt; ((v, a) -&gt; v) -&gt; (v, a) -&gt; (v, a) -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">(v, a) -&gt; v
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(v, a)]
</span><a href="#local-6989586621679066469"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-74"></span><span>        </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; m (v, Maybe a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066477"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679066478"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="annot"><span class="hs-comment">{-|
Given a function `f` and bounds `(a, b)`,
find a local maximum of `f` within `(a, b)` using the golden section search.
If `f` is unimodal, this finds the global maximum on `(a, b)`.

Order of convergence is 1 (linear), rate of convergence is $\phi^{ -1}$ (the golden ratio).
-}</span></span><span>
</span><span id="line-83"></span><span id="local-6989586621679066356"><span id="local-6989586621679066357"><span id="local-6989586621679066358"><span class="annot"><a href="DP.html#goldenSectionSearch"><span class="hs-identifier hs-type">goldenSectionSearch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Floating</span></span><span> </span><span class="annot"><a href="#local-6989586621679066356"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679066357"><span class="hs-identifier hs-type">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679066358"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066356"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066358"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066357"><span class="hs-identifier hs-type">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066356"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066356"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066358"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066356"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679066357"><span class="hs-identifier hs-type">y</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-84"></span><span id="goldenSectionSearch"><span class="annot"><span class="annottext">goldenSectionSearch :: forall x y (m :: * -&gt; *).
(Floating x, Ord y, Monad m) =&gt;
(x -&gt; m y) -&gt; x -&gt; x -&gt; Int -&gt; m (x, y)
</span><a href="DP.html#goldenSectionSearch"><span class="hs-identifier hs-var hs-var">goldenSectionSearch</span></a></span></span><span> </span><span id="local-6989586621679066499"><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679066500"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066500"><span class="hs-identifier hs-var">lo</span></a></span></span><span> </span><span id="local-6989586621679066501"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066501"><span class="hs-identifier hs-var">hi</span></a></span></span><span> </span><span id="local-6989586621679066502"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679066502"><span class="hs-identifier hs-var">maxIter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679066503"><span class="annot"><span class="annottext">mid :: x
</span><a href="#local-6989586621679066503"><span class="hs-identifier hs-var hs-var">mid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
</span><a href="#local-6989586621679066504"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066500"><span class="hs-identifier hs-var">lo</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066501"><span class="hs-identifier hs-var">hi</span></a></span><span>
</span><span id="line-86"></span><span>        </span><span id="local-6989586621679066505"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066505"><span class="hs-identifier hs-var">vLo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066500"><span class="hs-identifier hs-var">lo</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span id="local-6989586621679066506"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066506"><span class="hs-identifier hs-var">vHi</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066501"><span class="hs-identifier hs-var">hi</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span id="local-6989586621679066507"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066507"><span class="hs-identifier hs-var">vMid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066503"><span class="hs-identifier hs-var">mid</span></a></span><span> </span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; x -&gt; x -&gt; x -&gt; y -&gt; y -&gt; y -&gt; m (x, y)
forall {t}.
(Ord t, Num t) =&gt;
t -&gt; x -&gt; x -&gt; x -&gt; y -&gt; y -&gt; y -&gt; m (x, y)
</span><a href="#local-6989586621679066508"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679066502"><span class="hs-identifier hs-var">maxIter</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066500"><span class="hs-identifier hs-var">lo</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066501"><span class="hs-identifier hs-var">hi</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066503"><span class="hs-identifier hs-var">mid</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066505"><span class="hs-identifier hs-var">vLo</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066506"><span class="hs-identifier hs-var">vHi</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066507"><span class="hs-identifier hs-var">vMid</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621679066518"><span class="annot"><span class="annottext">invphi :: x
</span><a href="#local-6989586621679066518"><span class="hs-identifier hs-var hs-var">invphi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; x
forall a. Floating a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">sqrt</span></span><span> </span><span class="annot"><span class="annottext">x
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">x
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">x
</span><span class="hs-number">2</span></span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679066504"><span class="annot"><span class="annottext">split :: x -&gt; x -&gt; x
</span><a href="#local-6989586621679066504"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span id="local-6989586621679066524"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066524"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span id="local-6989586621679066525"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066525"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066524"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066518"><span class="hs-identifier hs-var">invphi</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066525"><span class="hs-identifier hs-var">x2</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066524"><span class="hs-identifier hs-var">x1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679066508"><span class="annot"><span class="annottext">go :: t -&gt; x -&gt; x -&gt; x -&gt; y -&gt; y -&gt; y -&gt; m (x, y)
</span><a href="#local-6989586621679066508"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679066545"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679066545"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679066546"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066546"><span class="hs-identifier hs-var">x1</span></a></span></span><span> </span><span id="local-6989586621679066547"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066547"><span class="hs-identifier hs-var">x2</span></a></span></span><span> </span><span id="local-6989586621679066548"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066548"><span class="hs-identifier hs-var">x3</span></a></span></span><span> </span><span id="local-6989586621679066549"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066549"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621679066550"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066550"><span class="hs-identifier hs-var">v2</span></a></span></span><span> </span><span id="local-6989586621679066551"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066551"><span class="hs-identifier hs-var">v3</span></a></span></span><span> </span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679066545"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679066553"><span class="annot"><span class="annottext">x4 :: x
</span><a href="#local-6989586621679066553"><span class="hs-identifier hs-var hs-var">x4</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
</span><a href="#local-6989586621679066504"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066546"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066547"><span class="hs-identifier hs-var">x2</span></a></span><span>
</span><span id="line-97"></span><span>        </span><span id="local-6989586621679066554"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066554"><span class="hs-identifier hs-var">v4</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066553"><span class="hs-identifier hs-var">x4</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066554"><span class="hs-identifier hs-var">v4</span></a></span><span> </span><span class="annot"><span class="annottext">y -&gt; y -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066550"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-99"></span><span>            </span><span class="annot"><span class="annottext">t -&gt; x -&gt; x -&gt; x -&gt; y -&gt; y -&gt; y -&gt; m (x, y)
</span><a href="#local-6989586621679066508"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679066545"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066546"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066553"><span class="hs-identifier hs-var">x4</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066547"><span class="hs-identifier hs-var">x2</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066549"><span class="hs-identifier hs-var">v1</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066554"><span class="hs-identifier hs-var">v4</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066550"><span class="hs-identifier hs-var">v2</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-101"></span><span>            </span><span class="annot"><span class="annottext">t -&gt; x -&gt; x -&gt; x -&gt; y -&gt; y -&gt; y -&gt; m (x, y)
</span><a href="#local-6989586621679066508"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679066545"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066548"><span class="hs-identifier hs-var">x3</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066547"><span class="hs-identifier hs-var">x2</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066553"><span class="hs-identifier hs-var">x4</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066551"><span class="hs-identifier hs-var">v3</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066550"><span class="hs-identifier hs-var">v2</span></a></span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066554"><span class="hs-identifier hs-var">v4</span></a></span><span>
</span><span id="line-102"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679066559"><span class="annot"><span class="annottext">x :: x
</span><a href="#local-6989586621679066559"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066546"><span class="hs-identifier hs-var">x1</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066548"><span class="hs-identifier hs-var">x3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x -&gt; x -&gt; x
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">x
</span><span class="hs-number">2</span></span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679066560"><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066560"><span class="hs-identifier hs-var">xv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">x -&gt; m y
</span><a href="#local-6989586621679066499"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066559"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">(x, y) -&gt; m (x, y)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066559"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">y
</span><a href="#local-6989586621679066560"><span class="hs-identifier hs-var">xv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-comment">{-
The invariant maintained by `go _ a b c` is `b = split a c`.
This is evident in the `v4 &gt; v2` case, since `d = split a b`.

In the other, case we need that `b = split c d`.
Abbreviating $p = \phi$, recall that $1/p = p - 1$ and $p^2 = p + 1$.

We have
b = a + (c - a) / p = 2a + pc - pa - c
d = a + (b - a) / p = 2a + pd - pa - d

b = c + (a + (b - a) / p - c) / p
b = c + (a + (b - a) * (p - 1) - c) * (p - 1)
b = c + (2a - b + pb - pa - c) * (p - 1)
b = c + (2pa - pb + p^2b - p^2a - pc) + (-2a + b - pb + pa + c)
0 = 2c + 3pa - 2pb + p^2b - p^2a - pc - 2a
0 = 2c + 3pa - 2p(2a + pc - pa - c) + (p + 1)(2a + pc - pa - c) - p^2a - pc - 2a
0 = 2c + 3pa - 4pa - 2p^2c + 2p^2a + 2pc + 2pa + p^2c - p^2a - pc + 2a + pc - pa - c - p^2a - pc - 2a
0 = c - p^2c + pc
0 = c - (p + 1)c + pc
0 = 0.
-}</span><span>
</span><span id="line-128"></span><span>    </span><span>
</span><span id="line-129"></span><span class="annot"><span class="hs-comment">{-|
Given an injection `mk` of values `x` into actions `a`,
this procedure performs a golden section search over `x` for the objective of `mk x`. 
-}</span></span><span>
</span><span id="line-133"></span><span id="local-6989586621679066366"><span id="local-6989586621679066367"><span id="local-6989586621679066368"><span id="local-6989586621679066369"><span id="local-6989586621679066370"><span class="annot"><a href="DP.html#uniSearch"><span class="hs-identifier hs-type">uniSearch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679066366"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679066367"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Floating</span></span><span> </span><span class="annot"><a href="#local-6989586621679066368"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066368"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066369"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066368"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066368"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="DP.html#Search"><span class="hs-identifier hs-type">Search</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066370"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066366"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066367"><span class="hs-identifier hs-type">m</span></a></span></span></span></span></span></span><span>
</span><span id="line-134"></span><span id="uniSearch"><span class="annot"><span class="annottext">uniSearch :: forall v (m :: * -&gt; *) x a s.
(Ord v, Monad m, Floating x) =&gt;
Int -&gt; (x -&gt; a) -&gt; x -&gt; x -&gt; Search s v a m
</span><a href="DP.html#uniSearch"><span class="hs-identifier hs-var hs-var">uniSearch</span></a></span></span><span> </span><span id="local-6989586621679066569"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679066569"><span class="hs-identifier hs-var">maxIter</span></a></span></span><span> </span><span id="local-6989586621679066570"><span class="annot"><span class="annottext">x -&gt; a
</span><a href="#local-6989586621679066570"><span class="hs-identifier hs-var">mkAct</span></a></span></span><span> </span><span id="local-6989586621679066571"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066571"><span class="hs-identifier hs-var">lo</span></a></span></span><span> </span><span id="local-6989586621679066572"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066572"><span class="hs-identifier hs-var">hi</span></a></span></span><span> </span><span class="annot"><span class="annottext">s
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679066573"><span class="annot"><span class="annottext">a -&gt; m v
</span><a href="#local-6989586621679066573"><span class="hs-identifier hs-var">actValue'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679066574"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066574"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679066575"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066575"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(x -&gt; m v) -&gt; x -&gt; x -&gt; Int -&gt; m (x, v)
forall x y (m :: * -&gt; *).
(Floating x, Ord y, Monad m) =&gt;
(x -&gt; m y) -&gt; x -&gt; x -&gt; Int -&gt; m (x, y)
</span><a href="DP.html#goldenSectionSearch"><span class="hs-identifier hs-var">goldenSectionSearch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m v
</span><a href="#local-6989586621679066573"><span class="hs-identifier hs-var">actValue'</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; m v) -&gt; (x -&gt; a) -&gt; x -&gt; m v
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; a
</span><a href="#local-6989586621679066570"><span class="hs-identifier hs-var">mkAct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066571"><span class="hs-identifier hs-var">lo</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066572"><span class="hs-identifier hs-var">hi</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679066569"><span class="hs-identifier hs-var">maxIter</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; m (v, Maybe a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066575"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe a) -&gt; a -&gt; Maybe a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; a
</span><a href="#local-6989586621679066570"><span class="hs-identifier hs-var">mkAct</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679066574"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="annot"><span class="hs-comment">{-|
`solveDP` solves a `DPProblem` in `IO` from a given initial state, returning the optimal action (if it exists) and its objective value.
Needs a reference to a (non-incorrect) table of actions and objective values.
-}</span></span><span>
</span><span id="line-142"></span><span id="local-6989586621679066382"><span id="local-6989586621679066384"><span id="local-6989586621679066385"><span class="annot"><a href="DP.html#solveDP"><span class="hs-identifier hs-type">solveDP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679066382"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-type">DPProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066382"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066384"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066385"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679066382"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066384"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066385"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066382"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066384"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066385"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-143"></span><span id="solveDP"><span class="annot"><span class="annottext">solveDP :: forall s v a.
Hashable s =&gt;
DPProblem s v a IO
-&gt; IORef (HashMap s (v, Maybe a)) -&gt; s -&gt; IO (v, Maybe a)
</span><a href="DP.html#solveDP"><span class="hs-identifier hs-var hs-var">solveDP</span></a></span></span><span> </span><span id="local-6989586621679066594"><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066594"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679066595"><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066595"><span class="hs-identifier hs-var">memRef</span></a></span></span><span> </span><span id="local-6989586621679066596"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066596"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679066597"><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066597"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a)) -&gt; IO (HashMap s (v, Maybe a))
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066595"><span class="hs-identifier hs-var">memRef</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066597"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a) -&gt; s -&gt; Maybe (v, Maybe a)
forall k v. (Eq k, Hashable k) =&gt; HashMap k v -&gt; k -&gt; Maybe v
</span><span class="hs-operator hs-var">HM.!?</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066596"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679066599"><span class="annot"><span class="annottext">(v, Maybe a)
</span><a href="#local-6989586621679066599"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; IO (v, Maybe a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(v, Maybe a)
</span><a href="#local-6989586621679066599"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><span class="annottext">Maybe (v, Maybe a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-comment">-- stops you from accidentally making a huge thunk by using maximumBy on tuples, for example.</span><span>
</span><span id="line-150"></span><span>            </span><span id="local-6989586621679066600"><span class="annot"><span class="annottext">r :: (v, Maybe a)
</span><a href="#local-6989586621679066600"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">v
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO -&gt; Search s v a IO
forall s v a (m :: * -&gt; *). DPProblem s v a m -&gt; Search s v a m
</span><a href="DP.html#search"><span class="hs-identifier hs-var">search</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066594"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066596"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((a -&gt; IO v) -&gt; IO (v, Maybe a)) -&gt; (a -&gt; IO v) -&gt; IO (v, Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO -&gt; s -&gt; (s -&gt; IO v) -&gt; a -&gt; IO v
forall s v a (m :: * -&gt; *).
DPProblem s v a m -&gt; s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
</span><a href="DP.html#actValue"><span class="hs-identifier hs-var">actValue</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066594"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066596"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((v, Maybe a) -&gt; v) -&gt; IO (v, Maybe a) -&gt; IO v
forall a b. (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; v
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(IO (v, Maybe a) -&gt; IO v) -&gt; (s -&gt; IO (v, Maybe a)) -&gt; s -&gt; IO v
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
-&gt; IORef (HashMap s (v, Maybe a)) -&gt; s -&gt; IO (v, Maybe a)
forall s v a.
Hashable s =&gt;
DPProblem s v a IO
-&gt; IORef (HashMap s (v, Maybe a)) -&gt; s -&gt; IO (v, Maybe a)
</span><a href="DP.html#solveDP"><span class="hs-identifier hs-var">solveDP</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066594"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066595"><span class="hs-identifier hs-var">memRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>            </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
-&gt; (HashMap s (v, Maybe a) -&gt; HashMap s (v, Maybe a)) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066595"><span class="hs-identifier hs-var">memRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
-&gt; (v, Maybe a) -&gt; HashMap s (v, Maybe a) -&gt; HashMap s (v, Maybe a)
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066596"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(v, Maybe a)
</span><a href="#local-6989586621679066600"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>            </span><span class="annot"><span class="annottext">(v, Maybe a) -&gt; IO (v, Maybe a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(v, Maybe a)
</span><a href="#local-6989586621679066600"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="annot"><span class="hs-comment">{-|
`execDP` solves a `DPProblem` in `IO` from a given initial state, returning the entire table mapping states to their optimal actions and objective values.
Uses an `IORef` to a `HashMap` for memoization.
-}</span></span><span>
</span><span id="line-158"></span><span id="local-6989586621679066401"><span id="local-6989586621679066402"><span id="local-6989586621679066403"><span class="annot"><a href="DP.html#execDP"><span class="hs-identifier hs-type">execDP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679066401"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-type">DPProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066401"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066402"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066403"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066401"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679066401"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066402"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066403"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-159"></span><span id="execDP"><span class="annot"><span class="annottext">execDP :: forall s v a.
Hashable s =&gt;
DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
</span><a href="DP.html#execDP"><span class="hs-identifier hs-var hs-var">execDP</span></a></span></span><span> </span><span id="local-6989586621679066609"><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066609"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679066610"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066610"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621679066611"><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066611"><span class="hs-identifier hs-var">memRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a) -&gt; IO (IORef (HashMap s (v, Maybe a)))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">(v, Maybe a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
-&gt; IORef (HashMap s (v, Maybe a)) -&gt; s -&gt; IO (v, Maybe a)
forall s v a.
Hashable s =&gt;
DPProblem s v a IO
-&gt; IORef (HashMap s (v, Maybe a)) -&gt; s -&gt; IO (v, Maybe a)
</span><a href="DP.html#solveDP"><span class="hs-identifier hs-var">solveDP</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066609"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066611"><span class="hs-identifier hs-var">memRef</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066610"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a)) -&gt; IO (HashMap s (v, Maybe a))
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (HashMap s (v, Maybe a))
</span><a href="#local-6989586621679066611"><span class="hs-identifier hs-var">memRef</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><span class="hs-comment">{-| A &quot;trick&quot; to reduce the output of `execDP` to only the relevant parts.
Instantiate this with the output of an `execDP` call and rerun `execDP` with this problem instead.
-}</span></span><span>
</span><span id="line-167"></span><span id="local-6989586621679066411"><span id="local-6989586621679066412"><span id="local-6989586621679066413"><span id="local-6989586621679066414"><span class="annot"><a href="DP.html#reducedP"><span class="hs-identifier hs-type">reducedP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679066411"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679066412"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679066413"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679066413"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066412"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066414"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-type">DPProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066413"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066412"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066414"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-type">DPProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066413"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066412"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066414"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066411"><span class="hs-identifier hs-type">m</span></a></span></span></span></span></span><span>
</span><span id="line-168"></span><span id="reducedP"><span class="annot"><span class="annottext">reducedP :: forall (m :: * -&gt; *) v s a.
(Monad m, Ord v, Hashable s) =&gt;
HashMap s (v, Maybe a) -&gt; DPProblem s v a m -&gt; DPProblem s v a m
</span><a href="DP.html#reducedP"><span class="hs-identifier hs-var hs-var">reducedP</span></a></span></span><span> </span><span id="local-6989586621679066618"><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066618"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621679066619"><span class="annot"><span class="annottext">DPProblem s v a m
</span><a href="#local-6989586621679066619"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Search s v a m
-&gt; (s -&gt; (s -&gt; m v) -&gt; a -&gt; m v) -&gt; DPProblem s v a m
forall s v a (m :: * -&gt; *).
Search s v a m
-&gt; (s -&gt; (s -&gt; m v) -&gt; a -&gt; m v) -&gt; DPProblem s v a m
</span><a href="DP.html#DPProblem"><span class="hs-identifier hs-var">DPProblem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(s -&gt; Either v [a]) -&gt; Search s v a m
forall v (m :: * -&gt; *) s a.
(Ord v, Monad m) =&gt;
(s -&gt; Either v [a]) -&gt; Search s v a m
</span><a href="DP.html#enumSearch"><span class="hs-identifier hs-var">enumSearch</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; Either v [a]
</span><a href="#local-6989586621679066620"><span class="hs-identifier hs-var">reducedA</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
</span><a href="#local-6989586621679066621"><span class="hs-identifier hs-var">reducedV</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679066620"><span class="annot"><span class="annottext">reducedA :: s -&gt; Either v [a]
</span><a href="#local-6989586621679066620"><span class="hs-identifier hs-var hs-var">reducedA</span></a></span></span><span> </span><span id="local-6989586621679066622"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066622"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621679066628"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066628"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679066629"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679066629"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066618"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a) -&gt; s -&gt; (v, Maybe a)
forall k v.
(Eq k, Hashable k, HasCallStack) =&gt;
HashMap k v -&gt; k -&gt; v
</span><span class="hs-operator hs-var">HM.!</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066622"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Either v [a] -&gt; (a -&gt; Either v [a]) -&gt; Maybe a -&gt; Either v [a]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; Either v [a]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679066628"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; Either v [a]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([a] -&gt; Either v [a]) -&gt; (a -&gt; [a]) -&gt; a -&gt; Either v [a]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679066629"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621679066621"><span class="annot"><span class="annottext">reducedV :: s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
</span><a href="#local-6989586621679066621"><span class="hs-identifier hs-var hs-var">reducedV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPProblem s v a m -&gt; s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
forall s v a (m :: * -&gt; *).
DPProblem s v a m -&gt; s -&gt; (s -&gt; m v) -&gt; a -&gt; m v
</span><a href="DP.html#actValue"><span class="hs-identifier hs-var">actValue</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a m
</span><a href="#local-6989586621679066619"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><span class="hs-comment">{-|
`reducedDP` solves a `DPProblem` in `IO` from a given initial state, returning the table mapping reachable states to their optimal actions and objective values.

A state `s` is reachable if it's either initial, or the objective value of a reachable state `s'` after taking the optimal action refers to `s`.
-}</span></span><span>
</span><span id="line-178"></span><span id="local-6989586621679066426"><span id="local-6989586621679066427"><span id="local-6989586621679066428"><span class="annot"><a href="DP.html#reducedDP"><span class="hs-identifier hs-type">reducedDP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679066426"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679066427"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="DP.html#DPProblem"><span class="hs-identifier hs-type">DPProblem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066426"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066427"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679066428"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679066426"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HM.HashMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679066426"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679066427"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679066428"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-179"></span><span id="reducedDP"><span class="annot"><span class="annottext">reducedDP :: forall s v a.
(Hashable s, Ord v) =&gt;
DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
</span><a href="DP.html#reducedDP"><span class="hs-identifier hs-var hs-var">reducedDP</span></a></span></span><span> </span><span id="local-6989586621679066640"><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066640"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679066641"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066641"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679066642"><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066642"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
forall s v a.
Hashable s =&gt;
DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
</span><a href="DP.html#execDP"><span class="hs-identifier hs-var">execDP</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066640"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066641"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
forall s v a.
Hashable s =&gt;
DPProblem s v a IO -&gt; s -&gt; IO (HashMap s (v, Maybe a))
</span><a href="DP.html#execDP"><span class="hs-identifier hs-var">execDP</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap s (v, Maybe a) -&gt; DPProblem s v a IO -&gt; DPProblem s v a IO
forall (m :: * -&gt; *) v s a.
(Monad m, Ord v, Hashable s) =&gt;
HashMap s (v, Maybe a) -&gt; DPProblem s v a m -&gt; DPProblem s v a m
</span><a href="DP.html#reducedP"><span class="hs-identifier hs-var">reducedP</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap s (v, Maybe a)
</span><a href="#local-6989586621679066642"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">DPProblem s v a IO
</span><a href="#local-6989586621679066640"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679066641"><span class="hs-identifier hs-var">s</span></a></span></pre></body></html>